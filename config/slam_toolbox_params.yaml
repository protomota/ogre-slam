slam_toolbox:
  ros__parameters:

    # Plugin params
    solver_plugin: solver_plugins::CeresSolver
    ceres_linear_solver: SPARSE_NORMAL_CHOLESKY
    ceres_preconditioner: SCHUR_JACOBI
    ceres_trust_strategy: LEVENBERG_MARQUARDT
    ceres_dogleg_type: TRADITIONAL_DOGLEG
    ceres_loss_function: None
    ceres_num_threads: 16  # Limit threads to avoid "exceeds maximum available" warnings

    # ROS Parameters
    # NOTE: Using odom frame even without wheel odometry
    # SLAM publishes map→odom transform, static identity used for odom→base_link
    odom_frame: odom
    map_frame: map
    base_frame: base_link
    scan_topic: /scan
    mode: mapping  # mapping or localization

    # if you'd like to immediately start continuing a map at a given pose
    # or at the dock, but they are mutually exclusive, if pose is given
    # will use pose
    #map_file_name: test_steve
    #map_start_pose: [0.0, 0.0, 0.0]
    #map_start_at_dock: true

    debug_logging: false
    throttle_scans: 1
    transform_publish_period: 0.02  # 50 Hz TF publishing
    map_update_interval: 2.0        # Update map every 2 seconds (Jetson optimization)
    resolution: 0.05                # 5cm grid resolution (Jetson memory optimization)
    max_laser_range: 12.0           # RPLIDAR A1 max range
    minimum_time_interval: 0.1      # Minimum time between scans (was 0.5, now 0.1 for faster updates)
    transform_timeout: 0.2
    tf_buffer_duration: 30.0
    stack_size_to_use: 40000000     # program needs a larger stack size to serialize large maps

    # General Parameters
    use_scan_matching: true
    use_scan_barycenter: true
    minimum_travel_distance: 0.0    # Disabled - rely purely on time-based scan processing
    minimum_travel_heading: 0.0     # Disabled - rely purely on time-based scan processing
    scan_buffer_size: 20            # Increased from 10 - keep more scans for matching
    scan_buffer_maximum_scan_distance: 15.0  # Increased - allow matching against older scans
    link_match_minimum_response_fine: 0.05   # Lowered from 0.1 - accept weaker matches to avoid losing track
    link_scan_maximum_distance: 3.0          # Increased from 1.5 - allow larger jumps between scans
    loop_search_maximum_distance: 6.0        # Increased from 3.0 - search wider for loop closure
    do_loop_closing: true
    loop_match_minimum_chain_size: 6         # Reduced from 10 - close loops sooner
    loop_match_maximum_variance_coarse: 5.0  # Increased from 3.0 - more tolerant
    loop_match_minimum_response_coarse: 0.25 # Lowered from 0.35 - accept weaker loop matches
    loop_match_minimum_response_fine: 0.35   # Lowered from 0.45 - accept weaker loop matches

    # Correlation Parameters - Larger search space for noisy odometry
    correlation_search_space_dimension: 2.0   # Increased from 1.5 - search even wider
    correlation_search_space_resolution: 0.01
    correlation_search_space_smear_deviation: 0.1  # Max allowed value (0.005-0.1)

    # Correlation Parameters - Loop Closure Parameters
    loop_search_space_dimension: 12.0  # Increased from 8.0 - wider loop search
    loop_search_space_resolution: 0.05
    loop_search_space_smear_deviation: 0.05  # Increased from 0.03

    # Scan Matcher Parameters
    # Lower penalties = trust scan matching more than odometry
    distance_variance_penalty: 0.3   # Lowered from 0.5 - trust scan matching more
    angle_variance_penalty: 0.5      # Lowered from 1.0 - trust scan matching more

    fine_search_angle_offset: 0.00524    # Increased from 0.00349 (~0.3°) - wider fine search
    coarse_search_angle_offset: 0.524    # Increased from 0.349 (~30°) - wider coarse search
    coarse_angle_resolution: 0.0349
    minimum_angle_penalty: 0.8       # Lowered from 0.9 - more tolerant of angle differences
    minimum_distance_penalty: 0.4    # Lowered from 0.5 - more tolerant of distance differences
    use_response_expansion: true
